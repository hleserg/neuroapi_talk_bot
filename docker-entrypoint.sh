#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Yandex Cloud CLI

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if [ -z "$NEUROAPI_API_KEY" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: NEUROAPI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if [ -z "$HUGGINGFACE_API_KEY" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: HUGGINGFACE_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
if [ -z "$YANDEX_FOLDER_ID" ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: YANDEX_FOLDER_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –≥–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚úÖ Yandex Cloud Folder ID –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Yandex Cloud CLI
if command -v yc &> /dev/null; then
    echo "‚úÖ Yandex Cloud CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º yc CLI —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if [ ! -z "$YC_TOKEN" ]; then
        echo "üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º yc CLI —Å OAuth —Ç–æ–∫–µ–Ω–æ–º..."
        yc config set token "$YC_TOKEN"
        if yc iam create-token &> /dev/null; then
            echo "‚úÖ OAuth —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ IAM —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
        else
            echo "‚ùå –û—à–∏–±–∫–∞: OAuth —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"
        fi
    elif [ ! -z "$YC_SERVICE_ACCOUNT_KEY_FILE" ] && [ -f "$YC_SERVICE_ACCOUNT_KEY_FILE" ]; then
        echo "üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º yc CLI —Å –∫–ª—é—á–æ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞..."
        yc config set service-account-key "$YC_SERVICE_ACCOUNT_KEY_FILE"
        if yc iam create-token &> /dev/null; then
            echo "‚úÖ –ö–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ IAM —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
        else
            echo "‚ùå –û—à–∏–±–∫–∞: –ö–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"
        fi
    else
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Yandex Cloud –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo "   –î–ª—è —Ä–∞–±–æ—Ç—ã –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:"
        echo "   - YC_TOKEN (OAuth —Ç–æ–∫–µ–Ω) –∏–ª–∏"
        echo "   - YC_SERVICE_ACCOUNT_KEY_FILE (–ø—É—Ç—å –∫ –∫–ª—é—á—É —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)"
        echo "   –ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    fi
else
    echo "‚ùå Yandex Cloud CLI –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p /app/logs

echo "üé§ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
exec python bot.py
